'use strict';

var gulp = global.gulp = global.gulp || require('gulp');
var fs = global.fs = global.fs || require('fs');
var common = global.config = global.config || require('../utils/common.js');
var simpleGit = global.simpleGit = global.simpleGit || require('simple-git');
var currentPackage = common.currentPackage;
var glob = require('glob');

gulp.task('aspcore-publish', function (done) {
    if (fs.existsSync('./third-party/asp-core')) {
        var user = process.env.GITLAB_USER;
        var token = process.env.GITLAB_TOKEN;
        var stageBranch = common.isMasterBranch ? 'master' : 'development';
        var ej2aspRepo = 'https://' + user + ':' + token + '@gitlab.syncfusion.com/essential-studio/ej2-asp-core.git';

        simpleGit('./third-party/asp-core').init()
            .add('./*')
            .commit('(EJ2-000): ' + currentPackage + ' aspcore properties published')
            .push(ej2aspRepo, stageBranch, function () {
                console.log(currentPackage + ' - package published in github');
                done();
            });

    } else {
        done();
    }
});

gulp.task('asp-generate-projectfile', function (done) {
    var str = '';
    var csFiles = glob.sync('./third-party/asp-core/src/**/*.cs', {
        silent: true, ignore: ['./third-party/asp-core/src/Base/ContentTemplate.cs',
            './third-party/asp-core/src/Base/HtmlExtention.cs', './third-party/asp-core/src/obj/**/*.cs',
            './third-party/asp-core/src/bin/**/*.cs', './third-party/asp-core/src/*.cs']
    });
    for (var m = 0; m < csFiles.length; m++) {
        var fileName = csFiles[m].replace('./third-party/asp-core/src/', '');
        str = str + '<Compile Include="' + fileName.replace(/\//g, '\\') + '" />\n';
    }
    var mvc4csproj = fs.readFileSync('./third-party/asp-core/src/Syncfusion.EJ2_MVC4.csproj', 'utf8');
    mvc4csproj = mvc4csproj.replace(/<!--#START-->([^]*)<!--#STOP-->/g, '<!--#START-->\n' + str + '<!--#STOP-->\n');
    fs.writeFileSync('./third-party/asp-core/src/Syncfusion.EJ2_MVC4.csproj', mvc4csproj);
    var mvc5csproj = fs.readFileSync('./third-party/asp-core/src/Syncfusion.EJ2_MVC4.csproj', 'utf8');
    mvc5csproj = mvc5csproj.replace(/<!--#START-->([^]*)<!--#STOP-->/g, '<!--#START-->\n' + str + '<!--#STOP-->\n');
    fs.writeFileSync('./third-party/asp-core/src/Syncfusion.EJ2_MVC5.csproj', mvc5csproj);
    done();
});