'use strict';

var fs = global.fs = global.fs || require('fs');
var gulp = global.gulp = global.gulp || require('gulp');
var common = global.config = global.config || require('../utils/common.js');
var angularApiGenerator = require('../generators/angular-api-generator.js');
var reactApiGenerator = require('../generators/react-api-generator.js');
var simpleGit = global.simpleGit = global.simpleGit || require('simple-git');
var runSequence = global.runSequence = global.runSequence || require('run-sequence');

var localpath = './ej2-docs/src/';
var currentPackage = common.currentPackage;

/**
 * Generates Angular Api
 */
gulp.task('angular-api-gen', function(done) {
    publishApi('angular', done);
});

/**
 * Generates React Api
 */
gulp.task('react-api-gen', function(done) {
    publishApi('react', done);
});

gulp.task('angular-api', function(done) {
    runSequence('typedoc', 'angular-api-gen', done);
});

gulp.task('react-api', function(done) {
    runSequence('typedoc', 'react-api-gen', done);
});

gulp.task('local-angular-api', function() {
    angularApiGenerator.generateAngularApi(localpath);
});

gulp.task('local-react-api', function() {
    reactApiGenerator.generateReactApi(localpath);
});

function publishApi(repo, done) {
    if (!fs.existsSync('./ej2-docs')) {
        fs.mkdirSync('./ej2-docs');

        var user = process.env.GITLAB_USER;
        var token = process.env.GITLAB_TOKEN;
        var stageBranch = common.isMasterBranch ? 'master' : common.stagingBranch;
        var ej2DocRepo = 'https://' + user + ':' + token + '@gitlab.syncfusion.com/essential-studio/ej2-' + repo + '-docs.git';
        simpleGit().clone(ej2DocRepo, './ej2-docs', function(err) {
            if (err) {
                done(err);
                return;
            }
        }).then(function() {
            simpleGit('./ej2-docs').checkout(stageBranch, function(err) {
                if (err) {
                    done(err);
                    return;
                }
                angularApiGenerator.clearComponentFolder(localpath);
                var isApiGenerated = false;
                if(repo === 'angular') {
                    isApiGenerated = angularApiGenerator.generateAngularApi(localpath);
                } else if(repo === 'react') {
                    isApiGenerated = reactApiGenerator.generateReactApi(localpath);
                }
                // create api md files from typedoc
                if (isApiGenerated) {
                    // push updated ej2-docs content to gitlab
                    simpleGit('./ej2-docs').init()
                        .add('./*')
                        .commit('documentation(EJ2-000): ' + currentPackage + ' -' + repo + ' api content published')
                        .pull(stageBranch)
                        .push(ej2DocRepo, stageBranch, function() {
                            console.log(currentPackage + ' - ej2 ' + repo + ' docs api content published');
                            done();
                        });
                } else {
                    done();
                }
            });
        });
    } else {
        done();
        return;
    }
}