'use strict';

var gulp = global.gulp = global.gulp || require('gulp');
var common = global.config = global.config || require('../utils/common.js');
var runSequence = global.runSequence = global.runSequence || require('run-sequence');
var fs = global.fs = global.fs || require('fs');
var shelljs = require('shelljs');

gulp.task('aspcore-checkout', function (done) {
    common.checkout('asp-core', 'asp-core', function () {
        var branchname = common.isMasterBranch ? 'master' : 'development';
        shelljs.cd('./third-party/asp-core/');
        shelljs.exec('git checkout ' + branchname);
        shelljs.cd('../../');
        done();
    });
});

gulp.task('aspcore-generate', function (done) {
    var aspSrcGen = require('../third-party/asp-core/src-generator.js');
    var propGen = require('../third-party/asp-core/property-reader');
    var propCollection = propGen(JSON.parse(fs.readFileSync('./public/api/file.json')));
    aspSrcGen(JSON.parse(fs.readFileSync('./third-party/config.json')), propCollection, done);
});

gulp.task('aspcore-build', function (done) {
    runSequence('aspcore-checkout', 'aspcore-generate', done);
});