'use strict';

// Node JS global scope
var gulp = global.gulp = global.gulp || require('gulp');
global.config = global.config || require('../utils/common.js');
var path = global.path = global.path || require('path');

var config = global.config.config();

/**
 * Run test once and exit
 */
gulp.task('test', ['scripts'], function (done) {
    var karma = require('karma');
    var spawn = require('child_process').spawn;
    var service = spawn('node', [path.join(__dirname, '../../services/V4service.js')]);

    new karma.Server({
        configFile: __dirname + config.karma,
        singleRun: true
    }, function (e) {
        done(e === 0 ? null : 'karma exited with status ' + e);
        service.kill();
    }).start();
});

/**
 * Watch for file changes and re-run tests on each change
 */
gulp.task('tdd', ['watch-ts'], function (done) {
    var karma = require('karma');
    var spawn = require('child_process').spawn;
    var service = spawn('node', [path.join(__dirname, '../../services/V4service.js')]);

    new karma.Server({
        configFile: __dirname + config.karma
    }, function () {
        done();
        service.kill();
    }).start();
});


/**
 * Test build task common functions
 */
gulp.task('build-test', ['js-hint'], function () {
    var jasmineNode = require('gulp-jasmine-node');
    return gulp.src(['spec/**/*spec.js'])
        .pipe(jasmineNode({
            timeout: 10000
        }));
});